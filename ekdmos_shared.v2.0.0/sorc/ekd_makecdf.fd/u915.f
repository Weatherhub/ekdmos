      SUBROUTINE U915(KFILDI,KFILDO,
     1                ICALL,CCALL,ISDATA,SDATA,NGP,MWORK,NAME,
     2                ND1,ID,IDPARS,TRESHL,TRESHU,JD,JP,
     3                ITAU,KER,ISD,SD,DS,NCAT,
     4                ISCALD,IPLAIN,PLAIN,L3264B,L3264W,ND4,
     5                XDATA,SDDATA,ND2,PLAINT,IPLAINT,
     6                ICALLD,CCALLD,IPACK,DATA,IWORK,ND5,
     7                IS0,IS1,IS2,IS4,ND7,
     8                IDATE,NWORK,ND8,
     9                LSTORE,ND9,CORE,ND10,NBLOCK,
     A                XAXIS,PDF,CDF,ND11,CDFTH,XCDF,ND12)
C
C       SUBPROGRAM: U915
C
C       PRGMMR: WIEDENFELD/GLAHN        ORG: W/OSD211     DATE: 07-11-05
C
C       PURPOSE
C           PROGRAM U915 IS USED TO READ DATA FROM A MOS-2000
C           EXTERNAL RANDOM ACCESS FILE, PERFORM COMPUTATIONS, AND
C           WRITE THE RESULTS BACK TO THAT SAME FILE, AS WELL
C           AS TO A SEQUENTIAL.  THIS PROGRAM IS INTENDED FOR KERNEL 
C           DENSITY FITTING AND/OR OUTPUTTING REPRESENTATIONS OF THE CDF.
C           DATA CAN BE PRINTED.  THE PRINTING
C           FORMAT IS GOVERNED BY USER INPUT; THE WRITING PRECISION
C           IS THE SAME AS INPUT.  THIS PROGRAM SHOULD
C           RUN ON EITHER THE HP UNIX PLATFORM WHICH USES 32-BIT
C           INTEGERS OR THE CRAY UNIX PLATFORM WHICH USES 64-BIT
C           INTEGERS.  THE ONLY DIFFERENCE IS THAT THE DRIVER
C           DRU915 IS  COMPILED WITH THE PARAMETER STATEMENT:
C
C       07-11-05  WIEDENFELD MERGED U910,U710, AND U715
C       09-11-29   VEENHUIS  ADDED ND2 TO CALL TO INT915.
C                            INT915 NOW CHECKS TO MAKE SURE
C                            THE NUMBER OF ENSEMBLE MEMBERS
C                            WILL NOT EXCEED ND2.
C       10-11-29  VEENHUIS   CHANGED THE WAY THE 'G' IS STIPPED.
C                            THE ORIGINAL WAY DID NOT PERSERVE
C                            THE TRESHOLD.
C       10-12-01  VEENHUIS   ADDED MODRUN. DEFAULT VALUE IS SET TO 76.
C                            ALLOWS THE OUTPUT DD TO BE SET.
C       11-02-28  VEENHUIS   MODIFICATIONS TO USE THE SPREAD
C                            SKILL RELATIONSHIP CALCULATED
C                            BY U714. ADDED KFILAI TO CALLS TO
C                            INT714 AND OPTY. KFILAI IS THE
C                            FILE UNIT FOR THE SPREAD SKILL FILE
C                            READ FROM THE CONTROL FILE.
C       11-04-06  WAGNER     ADDED MODRUN TO CALL TO OPTY. 
C       11-03-21  VEENHUIS   ADDED ITABLE AND CODE TO 'RESET' THE PQPF
C                            IDS TO THE UNCONDITIONAL IDS.
C
C        VARIABLES
C              KFILDI - UNIT NUMBER TO READ INPUT FILE 'U915.CN'.
C                       SET BY DATA STATEMENT TO 5 IN DRU915.
C              KFILDO - UNIT NUMBER OF OUTPUT (PRINT) FILE.  THIS IS SET
C                       BY DATA STATEMENT TO 12 IN DRU915.  LATER, IN IPOPEN,
C                       IF IP(1) NE 0, KFILDO IS SET = IP(1).  THIS ALLOWS
C                       CHANGING THE "DEFAULT" PRINT FILE ON THE FLY.
C                       OTHERWISE, ON SOME SYSTEMS, THE OUTPUT FILE MIGHT
C                       HAVE THE SAME NAME AND BE OVERWRITTEN.  WHEN THE
C                       OUTPUT FILE IS NOT THE ORIGINAL DEFAULT, THE NAME
C                       IS GENERATED AND CAN BE DIFFERENT FOR EACH RUN.
C                       THIS ALLOWS SAVING EACH OUTPUT AND NOT HAVING IT
C                       OVERWRITTEN.
C        ICALL(L,K,J) - CALL LETTERS, EQUIVALENCED TO CCALL( , )
C                       (L=1,2) (K=1,ND1) (J=1,6).
C          CCALL(K,J) - 8-CHARACTER STATION CALL LETTERS (OR GRIDPOINT
C                       LOCATIONS FOR GRID DEVELOPMENT) TO PROVIDE
C                       OUTPUT FOR (J=1) AND 5 POSSIBLE OTHER STATION
C                       CALL LETTERS (J=2,6) THAT CAN BE USED INSTEAD
C                       IF THE PRIMARY (J=1) STATION CANNOT BE FOUND
C                       IN AN INPUT DIRECTORY (K=1,NSTA).  ALL STATION
C                       DATA ARE KEYED TO THIS LIST.  (CHARACTER*8)
C           ISDATA(K) - WORK ARRAY (K=1,NSTA).
C            SDATA(K) - WORK ARRAY (K=1,NSTA).  USED AS STALAT( ) IN INT915.
C              NGP(J) - THE NUMBER OF STATIONS IN EACH GROUP (J=1,KGP).
C          XDATA(K,L) - THE ARRAY USED TO HOLD DATA FOR OUTPUT (K=1,NSTA)
C                       (L=1,ND2).  USED AS STALON( ) IN INT915.
C            MWORK(J) - WORK ARRAY (J=1,ND1).
C             NAME(K) - NAMES OF STATIONS (K=1,NSTA).  (CHARACTER*20)
C                 ND1 - MAXIMUM NUMBER OF STATIONS THAT CAN BE DEALT WITH.
C                       STORAGE SPACE IS HIGHLY DEPENDENT ON ND1.
C                 ND2 - MAXIMUM NUMBER OF VARIABLES TO BE DEALT WITH
C                       IN A SERIES.  THIS IS MAINLY FOR A GROUP OF
C                       PROBABILITY FORECASTS.
C             ID(J,N) - THE INTEGER VARIABLE ID'S (J=1,4) (N=1,NVRBL).
C         IDPARS(J,N) - THE PARSED, INDIVIDUAL COMPONENTS OF THE VARIABLE
C                       ID'S CORRESPONDING TO ID( ,N) (J=1,15), (N=1,NVRBL).
C                       (OUTPUT)
C                       J=1--CCC (CLASS OF VARIABLE),
C                       J=2--FFF (SUBCLASS OF VARIABLE),
C                       J=3--B (BINARY INDICATOR),
C                          0 = NOT BINARY,
C                          1 = CUMULATIVE FROM ABOVE, VALUES GE LOWER THRESHOLD
C                              TRESHL = 1,
C                          2 = CUMULATIVE FROM BELOW, VALUES LT UPPER THRESHOLD
C                              TRESHU = 1.
C                          3 = DISCRETE BINARY.  VALUES GE LOWER THRESHOLD AND
C                              LT UPPER THRESHOLD = 1.
C                          5 = GRID BINARY.  VALUES GE LOWER THRESHOLD
C                          ONLY THE VALUE OF 0, 1, OR 5 SHOULD BE USED FOR
C                          PREDICTORS;
C                          0, 1, 2, OR 3 CAN BE USED FOR PREDICTANDS.
C                       J=4--DD (DATA SOURCE, MODEL NUMBER),
C                       J=5--V (VERTICAL APPLICATION),
C                       J=6--LBLBLBLB (BOTTOM OF LAYER, 0 IF ONLY 1 LAYER),
C                       J=7--LTLTLTLT (TOP OF LAYER),
C                       J=8--T (TRANSFORMATION),
C                       J=9--RR (RUN TIME OFFSET, ALWAYS + AND BACK IN TIME),
C                       J=10--OT (TIME APPLICATION),
C                       J=11--OH (TIME PERIOD IN HOURS),
C                       J=12--TAU (PROJECTION IN HOURS),
C                       J=13--I (INTERPOLATION TYPE),
C                       J=14--S (SMOOTHING INDICATOR), AND
C                       J=15--G (GRID INDICATOR).
C           TRESHL(N) - THE LOWER BINARY THRESHOLD CORRESPONDING TO IDPARS( ,N)
C                       (N=1,ND4).
C           TRESHU(N) - THE UPPER BINARY THRESHOLD CORRESPONDING TO IDPARS( ,N)
C                       (N=1,ND4).
C             JD(J,N) - THE BASIC INTEGER VARIABLE ID'S (J=1,4) (N=1,ND4).
C                       THIS IS THE SAME AS ID(J,N), EXCEPT THAT THE FOLLOWING
C                       PORTIONS ARE OMITTED:
C                       B = IDPARS(3, ),
C                       G = IDPARS(15, ), AND
C                       TRESHL( ).
C                       JD( , ) IS USED TO IDENTIFY WHICH CALCULATIONS
C                       CAN BE MADE DIRECTLY IN U915, WHICH IS ONLY FORMING
C                       BINARIES.  THE "G" VARIABLE HAS NO MEANING IN U915,
C                       IT BEING ONLY FOR POSSIBLE USE IN U201.
C             JP(J,N) - CONTROLS THE OUTPUT BY VARIABLE (N=1,ND4).
C                       J=1--INDICATES WHETHER (>0) OR NOT (=0) VARIABLE N
C                            WILL BE WRITTEN TO THE BINARY OUTPUT FILE
C                            WHEN KFILIO NE 0;
C                       J=2--INDICATES WHETHER (>0) OR NOT (=0) VARIABLE N
C                            WILL BE WRITTEN TO UNIT IP(16) WITH THE FORMAT
C                            PROVIDED WITH THE VARIABLE; AND
C                       J=3--INDICATES WHETHER (>0) OR NOT (=0) VARIABLE N
C                            WILL BE WRITTEN TO UNIT IP(15) NOT UNDER
C                            CONTROL OF THE FORMAT PROVIDED BUT TO THE
C                            RESOLUTION PACKED.
C             ITAU(N) - THE NUMBER OF HOURS TO ADD TO NDATE TO GET
C                       THE VARIABLE N (N=1,ND4).  THIS IS THE
C                       "LOOKAHEAD" FEATURE.
C              KER(N) - DESIGNATES THE KERNEL TO BE USED FOR VARIABLE N
C                       (N=1,ND4).
C                       1 = NORMAL (GAUSIAN).
C              ISD(N) - DESIGNATES WHETHER THE KERNEL WIDTH FOR VARIABLE N
C                       (N=1,ND4) IS TO BE TAKEN FROM SD( ) IN THE VARIABLE
C                       RECORD OR FROM A PACKED INPUT RECORD.
C                       0 = COMES FROM PACKED RECORD;
C                       1 = USE SD( ) READ WITH THE VARIABLE.
C                       2 = WHEN THERE ARE MULTIPLE ENSEMBLES OR
C                           ONLY ONE ENSEMBLE AND SD( ) > 10,
C               SD(N) - A FACTOR TO USE IN THE SPREAD ADJUSTMENT FOR
C                       MULTIPLE ENSEMBLES FOR THIS VARIABLE N
C                       (N=1,ND4).
C               DS(N) - SCALING FACTOR FOR THE STANDARD DEVIATION FOR
C                       THIS VARIABLE (N=1,ND4).
C             NCAT(N) - A CATEGORY NUMBER FOR EACH VARIABLE (N=1,ND4).
C                       0 = THIS VARIABLE IS IN A SERIES, NOT THE FIRST.
C                       M = THIS VARIABLE IS THE FIRST OF A SERIES OF
C                           M VARIABLES.
C           ISCALD(N) - THE DECIMAL SCALING CONSTANT TO USE WHEN PACKING THE
C                       COLLATED DATA (N=1,ND4).  ISCALD COMES FROM THE
C                       VARIABLE CONSTANT FILE, MODIFIED TO BE 2 FOR GRID
C                       BINARIES, AND 0 FOR BINARIES.  ZERO WHEN NOT FOUND
C                       IN THE FILE.  NO BINARY SCALING IS PROVIDED FOR.
C       IPLAIN(L,J,N) - 32 CHARACTERS (L=1,L3264W) (J=1,4) OF PLAIN
C                       LANGUAGE DESCRIPTION OF VARIABLES (N=1,ND4).
C                       NOTE THAT THIS REQUIRES TWO 32-BIT WORDS TO HOLD
C                       THE DESCRIPTION BUT ONLY ONE 64-BIT WORD.
C                       EQUIVALENCED TO PLAIN( ).
C            PLAIN(N) - THE PLAIN LANGUAGE DESCRIPTION OF THE VARIABLES
C                       (N=1,ND4).  EQUIVALENCED TO IPLAIN( , , ).
C                       (CHARACTER*32)
C              L3264B - INTEGER WORD LENGTH IN BITS OF MACHINE BEING USED
C                       (EITHER 32 OR 64).  SET BY PARAMETER IN DRU915.
C              L3264W - NUMBER OF WORDS IN 64 BITS (EITHER 1 OR 2).
C                       CALCULATED BY PARAMETER, BASED ON L3464B.
C                 ND4 - MAXIMUM NUMBER OF VARIABLES THAT CAN BE DEALT WITH
C                       IN ONE RUN.
C          XDATA(K,L) - THE ARRAY USED BY SUBROUTINE VRBL75 AND VRBL76 FOR
C                       SINGLE VALUE VORECASTS (K=1,NSTA) (L=1,ND2).  USED AS
C                       STALON( ) IN INT915.
C         SDDATA(K,L) - USED FOR THE STANDARD ERRORS (K=1,NSTA) (L=1,ND2).
C                 ND2 - MAXIMUM NUMBER OF ENSEMBLE MEMBERS.
C              PLAINT - PLAIN TEXT FOR WRITING VECTOR FILE
C             IPLAINT - PLAIN TEXT FOR WRITING VECTOR FILE
C         ICALLD(L,K) - 8 STATION CALL LETTERS AS CHARACTERS IN AN INTEGER
C                       VARIABLE (L=1,L3264W) (K=1,ND5).
C                       NOTE THAT THIS REQUIRES TWO 32-BIT WORDS TO HOLD
C                       THE DESCRIPTION BUT ONLY ONE 64-BIT WORD.
C                       NEEDED IN CONST6 FOR ARGUMENT TO RDTDLM.
C                       EQUIVALENCED TO CCALLD( ).
C           CCALLD(K) - 8 STATION CALL LETTERS (K=1,ND5).  THIS LIST IS
C                       USED IN RDSTAD TO RETAIN THE ORIGINAL LIST IN
C                       CCALL( , ).
C            IPACK(J) - PACKED DATA READ FROM THE INPUT FILE(S)
C                       (J=1,ND5).
C             DATA(J) - WORK ARRAY (J=1,ND5).
C            IWORK(J) - WORK ARRAY (J=1,ND5).  USED AS IWBAN( ) IN
C                       INT915.
C                 ND5 - THE MAXIMUM NUMBER OF STATION CALL LETTERS ON
C                       THE INPUT FILES.  DIMENSION OF IWORK( ),
C                       DATA( ), AND IPACK( ) AND SECOND DIMENSION OF
C                       ICALLD( , ).
C                       MUST BE GE THE LARGEST RECORD ON THE INPUT
C                       VECTOR FILE(S).  MUST ALSO BE GE ND1.
C                       IT IS A SEPARATE DIMENSION FROM ND1, SO THAT
C                       ONLY THOSE ARRAYS REQUIRING INPUT FROM INPUT
C                       FILES ARE THIS LARGE.
C              IS0(J) - MOS-2000 GRIB SECTION 0 ID'S (J=1,4).
C              IS1(J) - MOS-2000 GRIB SECTION 1 ID'S (J=1,21+).
C              IS2(J) - MOS-2000 GRIB SECTION 2 ID'S (J=1,12).
C              IS4(J) - MOS-2000 GRIB SECTION 4 ID'S (J=1,4).
C                 ND7 - DIMENSION OF IS0( ), IS1( ), IS2( ), AND IS4( ).
C                       NOT ALL LOCATIONS ARE USED.  MAXIMUM SIZE IS FOR
C                       IS1( ) = 22 PLUS 32 CHARACTERS (ONE CHARACTER PER
C                       WORD) OF PLAIN TEXT = 54.
C            IDATE(J) - INITIAL DATE LIST (J=1,NDATES) WHICH MAY CONTAIN
C                       NEGATIVE VALUES INDICATING A DATE SPAN.
C                       THIS IS MODIFIED IN DATPRO TO CONTAIN THE COMPLETE
C                       DATE LIST WITH THE DATES IN THE SPANS FILLED IN
C                       (J=1,NDATES), WHERE NDATES HAS BEEN INCREASED
C                       IF NECESSARY.  DATES ARE INPUT AS YYMMDDHH AND
C                       MODIFIED TO YYYYMMDDHH.  ZEROS IN THE INPUT ARE
C                       ELIMINATED.  TERMINATOR IS 99999999.  MAXIMUM
C                       NUMBER OF DATES IS ND8.
C            NWORK(J) - WORK ARRAY (J=1,ND8).
C                 ND8 - MAXIMUM NUMBER OF DATES THAT CAN BE DEALT WITH.
C         LSTORE(L,J) - THE ARRAY HOLDING INFORMATION ABOUT THE DATA
C                       STORED IN THE MOS-2000 STORAGE SYSTEM
C                       (L=1,12) (J=1,LITEMS).
C                       L=1,4--THE 4 ID'S FOR THE DATA.
C                       L=5  --LOCATION OF STORED DATA.  WHEN IN CORE,
C                              THIS IS THE LOCATION IN CORE( ) WHERE
C                              THE DATA START.  WHEN ON DISK,
C                              THIS IS MINUS THE RECORD NUMBER WHERE
C                              THE DATA START.
C                       L=6  --THE NUMBER OF 4-BYTE WORDS STORED.
C                       L=7  --2 FOR DATA PACKED IN ENS GRIB, 1 FOR NOT.
C                       L=8  --THE DATE/TIME OF THE DATA IN FORMAT
C                              YYYYMMDDHH.
C                       L=9  --NUMBER OF TIMES DATA HAVE BEEN RETRIEVED.
C                       L=10 --NOT USED.
C                       L=11 --THE NUMBER OF THE FIRST PREDICTOR IN THE SORTED
C                              LIST IN ID( ,N) (N=1,VRBL) FOR WHICH THIS
C                              VARIABLE IS NEEDED, WHEN IT DOES NOT NEED
C                              TO BE STORED AFTER DAY 1.  WHEN THE VARIABLE
C                              MUST BE STORED (TO BE ACCESSED THROUGH OPTION)
C                              FOR ALL DAYS, ID(11,N) IS 7777 + THE NUMBER
C                              OF THE FIRST PREDICTOR IN THE SORTED LIST
C                              FOR WHICH THIS VARIABLE IS NEEDED.
C                       L=12 --MOT USED.
C                 ND9 - MAXIMUM NUMBER OF FIELDS STORED IN LSTORE( , ).
C                       SECOND DIMENSION OF LSTORE( , ).
C             CORE(J) - SPACE ALLOCATED FOR SAVING PACKED DATA
C                       (J=1,ND10).  WHEN THIS SPACE IS EXHAUSTED,
C                       SCRATCH DISK WILL BE USED.
C                ND10 - THE MEMORY IN WORDS ALLOCATED TO THE SAVING OF
C                       PACKED DATA IN CORE( ).  WHEN THIS
C                       SPACE IS EXHAUSTED, SCRATCH DISK WILL BE USED.
C              NBLOCK - BLOCK SIZE IN WORDS OF INTERNAL MOS-2000 DISK STORAGE.
C                       SINCE MUCH, IF NOT ALL, INTERNAL STORAGE WILL BE OF
C                       PACKED DATA, THE NUMBER OF BYTES WILL BE THE SAME FOR
C                       EITHER A 32- OR 64-BIT MACHINE.  THEREFORE, THE BLOCK
C                       SIZE IS SET BY PARAMETER TO VARY WITH L3264B.  IN THE
C                       PARAMETER STATEMENT, THE 6400 IS ARBITRARY, AND CAN BE
C                       CHANGED.  PERFORMANCE SHOULD NOT BE HIGHLY DEPENDENT
C                       ON THIS.  HOWEVER, IF TOO LARGE, SPACE WILL BE WASTED,
C                       AND IF TOO SMALL MANY RECORDS WILL BE NECESSARY TO
C                       HOLD EACH RECORD.  THE 6400 ACCOMMODATES 800 BYTES
C                       ON EITHER A 32- OR 64-BIT MACHINE.  SET BY PARAMETER
C                       IN DRU915.
C            XAXIS(J) - THE DATA VALUES ALONG THE X-AXIS, EACH
C                       VALUE CORRESPONDING TO A VALUE IN PDF(J) AND
C                       CDF(J) (J=1,NPCDF).
C              PDF(J) - THE PDF WRITTEN TO UNIT KFILAO (J=1,NPCDF).
C              CDF(J) - THE CDF WRITTEN TO UNIT KFILAO (J=1,NPCDF).
C                ND11 - THE MAXIMUM NUMBER OF VALUES IN XAXIS( ),
C                       PDF( ), AND CDF( ).
C            CDFTH(J) - THE THRESHOLDS, OR PROBABILITY LEVELS, FOR
C                       OUTPUTTING THE CDF FALUES (J=1,NCDFTH).
C           XCDF(K,J) - THE VALUES FOR STATION K (K=1,NSTA) OF THE CDF
C                       FOR EACH OF THE LEVELS IN CDFTH(J) (J=1,NCDFTH)
C                ND12 - THE DIMENSION OF CDFTH( ) AND SECOND DIMENSION
C                       OF CDF( , )
C   OUTPUT ARGUMENT LIST: NONE.  ALL INPUT TO OTHER SUBROUTINES.
C
C        DATA SET USE
C        INPUT FILES:
C      FORT.KFILDI    - UNIT NUMBER OF INPUT FILE.  SET BY DATA
C                       STATEMENT IN DRU915.  (INPUT)
C      FORT.KFIL10    - UNIT NUMBER OF ENS MOS-2000 INTERNAL FILE
C                       SYSTEM ACCESS.  SET BY DATA STATEMENT.
C                       (INPUT-OUTPUT)
C      FORT.KFILD(J)  - UNIT NUMBERS FOR WHERE THE STATION LIST (J=1)
C                       AND THE STATION DIRECTORY (J=2) RESIDES.
C                       (INPUT)
C      FORT.KFILDT    - UNIT NUMBER FOR READING THE DATE LIST.
C                       (INPUT)
C      FORT.KFILP     - UNIT NUMBER FOR READING THE VARIABLE LIST.
C                       (INPUT)
C      FORT.KFILCP    - UNIT NUMBER FOR VARIABLE CONSTANT FILE.
C                       (INPUT)
C      FORT.KFILRA(J) - UNIT NUMBERS FOR EXTERNAL RANDOM ACCESS FILES
C                       (J=1,5).  (INPUT/OUTPUT)
C
C        OUTPUT FILES: 
C      FORT.KFILDO    - UNIT NUMBER OF OUTPUT (PRINT) FILE.  SET BY
C                       DATA STATEMENT IN DRU915.  (OUTPUT)
C      FORT.KFIL10    - UNIT NUMBER OF ENS MOS-2000 INTERNAL FILE
C                       SYSTEM ACCESS.  SET BY DATA STATEMENT.
C                       (INPUT-OUTPUT)
C      FORT.KFILIO    - UNIT NUMBER OF SEQUENTIAL OUTPUT ENSPACK FILE.
C                       (OUTPUT)
C      FORT.KFILAO    - UNIT NUMBER OF ASCII OUTPUT FILE.
C                       ZERO MEANS OUTPUT WILL NOT BE WRITTEN.
C                       (OUTPUT)
C      FORT.IP(J)     - UNIT NUMBERS FOR OPTIONAL OUTPUT (J=1,25)
C                       (SEE IP( ) UNDER "VARIABLES" BELOW.)  (OUTPUT)
C      FORT.KFILRA(J) - UNIT NUMBERS FOR EXTERNAL RANDOM ACCESS FILES
C                       (J=1,5).  (INPUT/OUTPUT)
C         FORT.KFILAI - UNIT NUMBER OF SPREAD-SKILL INPUT ASCII FILE (INTERNAL).
C
C        VARIABLES
C              KFIL10 - UNIT NUMBER OF ENS MOS-2000 FILE SYSTEM ACCESS.
C                       SET BY DATA STATEMENT.
C              KFILIO - UNIT NUMBER OF SEQUENTIAL OUTPUT ENSPACK FILE.
C                       (INPUT)
C              KFILAO = UNIT NUMBER OF ASCII OUTPUT FILE.
C                       ZERO MEANS OUTPUT WILL NOT BE WRITTEN.
C              IPINIT - 4 CHARACTERS USED TO HELP IDENTIFY OUTPUT ASSOCIATED
C                       WITH THE IP( ) NUMBERS.  (CHARACTER*4)
C               IP(J) - EACH VALUE (J=1,25) INDICATES WHETHER (>1)
C                       OR NOT (=0) CERTAIN INFORMATION WILL BE WRITTEN.
C                       WHEN IP( ) > 0, THE VALUE INDICATES THE UNIT
C                       NUMBER FOR OUTPUT.  THESE VALUES SHOULD NOT BE THE
C                       SAME AS ANY KFILX VALUES EXCEPT POSSIBLY
C                       KFILDO, WHICH IS THE DEFAULT OUTPUT FILE.  THIS IS
C                       ASCII OUTPUT, GENERALLY FOR DIAGNOSTIC PURPOSES.
C                       THE FILE NAMES WILL BE 4 CHARACTERS 'U915',
C                       THEN 4 CHARACTERS FROM IPINIT, THEN 2 CHARACTERS
C                       FROM IP(J) (E.G., 'U915HRG130').  THE ARRAY IS
C                       INITIALIZED TO ZERO IN CASE LESS THAN THE EXPECTED
C                       NUMBER OF VALUES ARE READ IN.  EACH OUTPUT ASCII
C                       FILE WILL BE TIME STAMPED.  NOTE THAT THE TIME
C                       ON EACH FILE SHOULD BE VERY NEARLY THE SAME, BUT
C                       COULD VARY BY A FRACTION OF A SECOND.  IT IS
C                       INTENDED THAT ALL ERRORS BE INDICATED ON THE
C                       DEFAULT, SOMETIMES IN ADDITION TO BEING INDICATED
C                       ON A FILE WITH A SPECIFIC IP( ) NUMBER, SO THAT
C                       THE USER WILL NOT MISS AN ERROR.
C                       (1) = ALL ERRORS AND OTHER INFORMATION NOT
C                           SPECIFICALLY IDENTIFIED WITH OTHER IP( )
C                           NUMBERS.  WHEN IP(1) IS READ AS NONZERO,
C                           KFILDO, THE DEFAULT OUTPUT FILE UNIT NUMBER,
C                           WILL BE SET TO IP(1).  WHEN IP(1) IS READ
C                           AS ZERO, KFILDO WILL BE USED UNCHANGED.
C                       (2) = THE INPUT DATES IN IDATE( ).  WHEN THERE
C                           ARE ERRORS, PRINT WILL BE TO UNIT KFILDO AS
C                           WELL AS TO UNIT IP(2).
C                       (3) = THE OUTPUT DATES IN IDATE( ).  WHEN THERE
C                           ARE ERRORS, OUTPUT WILL BE TO UNIT KFILDO AS
C                           WELL AS TO UNIT IP(3).
C                       (4) = THE INPUT STATION LIST (CALL LETTERS ONLY).
C                           IF THERE ARE INPUT ERRORS, THE STATION LIST
C                           WILL BE WRITTEN TO THE DEFAULT OUTPUT FILE UNIT
C                           KFILDO AS WELL AS TO UNIT IP(4).
C                       (5) = THE STATIONS AND STATION DIRECTORY INFORMATION
C                           IN THE ORDER TO BE DEALT WITH IN U915.  THE
C                           STATIONS WILL BE IN ALPHABETICAL ORDER WITHIN
C                           EACH GROUP PROVIDED THE DIRECTORY IS.  IF THERE
C                           ARE INPUT ERRORS, THE STATION LIST WILL BE
C                           WRITTEN TO THE DEFAULT OUTPUT FILE UNIT KFILDO
C                           AS WELL AS TO UNIT IP(5).
C                       (6) = THE VARIABLE IDS AS THEY ARE BEING READ IN.
C                           THIS IS GOOD FOR CHECKOUT; FOR ROUTINE
C                           OPERATION, IP(7), IP(8), AND/OR IP(9),
C                           MAY BE BETTER.
C                       (7) = THE VARIABLE LIST IN SUMMARY FORM.
C                           IF THERE ARE ERRORS, THE VARIABLE LIST WILL
C                           BE WRITTEN TO THE DEFAULT OUTPUT FILE
C                           UNIT KFILDO AS WELL AS TO UNIT IP(7).
C                           THIS LIST INCLUDES THE PARSED ID'S IN IDPARS( , ).
C                       (8) = THE VARIABLE LIST IN SUMMARY FORM.
C                           THIS LIST INCLUDES THE PARSED ID'S IN
C                           IDPARS( , ).
C                       (9) = THE VARIABLE LIST IN SUMMARY FORM.
C                           THIS DIFFERS FROM (8) IN THAT (9) DOES NOT
C                           INCLUDE THE PARSED ID'S IN IDPARS( , ),
C                           BUT RATHER INCLUDES THE INFORMATION TAKEN
C                           FROM THE PREDICTOR CONSTANT FILE.
C                       (10) = NOT USED.
C                       (11) = NOT USED
C                       (12) = INDICATES WHETHER (>1) OR NOT (=0) THE LIST OF
C                           STATIONS ON THE INPUT FILES WILL BE PRINTED TO
C                           THE FILE WHOSE UNIT NUMBER IS IP(12).
C                       (13) = NOT USED.
C                       (14) = NOT USED.
C                       (15) = INDICATES WHETHER (>0) OR NOT (=0) THE DATA
C                           WILL BE WRITTEN TO UNIT IP(15) WHEN JP(3, ) >0.
C                           THIS PRINT IS LIKE THAT PROVIDED BY U201, AND
C                           IS SEPARATE FROM THE OPTIONAL LISTING PROVIDED
C                           UNDER CONTROL OF JP(2, ) WITH THE FORMAT
C                           PROVIDED.
C                       (16) = INDICATES WHETHER (>0) OR NOT (=0) THE DATA
C                           WILL BE WRITTEN TO UNIT IP(16) WHEN JP(2, ) >0.
C                           THIS PRINT IS UNDER CONTROL OF THE FORMAT
C                           PROVIDED WITH EACH VARIABLE.
C               JSTOP - THE NUMBER OF ERRORS THAT WILL BE TOLERATED ON THE
C                       TOTAL RUN BEFORE PROGRAM STOPS.
C              NREPLA - RECORD REPLACEMENT FLAG FOR WRITING RANDOM
C                       ACCESS FILE.
C                       0 = NOT REPLACING RECORD.
C                       1 = REPLACING, ERROR IF RECORD NOT FOUND TO
C                           REPLACE.
C                       2 = REPLACING, WRITE NEW RECORD IF RECORD NOT
C                           FOUND TO REPLACE.
C              NCHECK - IDENTIFICATION CHECKING FLAG FOR WRITING
C                       RANDOM ACCESS FILE.
C                       0 = DON'T CHECK FOR DUPLICATES.
C                       1 = CHECK FOR DUPLICATES, ERROR IF FOUND.
C              NPRINT - THE NUMBER OF CYCLES OF DATA TO PRINT UNDER
C                       JP(2, ) CONTROL.
C              NDATES - THE NUMBER OF DATES IN IDATE( ).
C           KFILRA(J) - HOLDS THE UNIT NUMBERS FOR ACCESSING THE MOS-2000
C                       EXTERNAL RANDOM ACCESS FILES (J=1,5).
C            KFILC(J) - UNIT NUMBER FOR PREDICTOR CONSTANT FILE.
C                       (INPUT)
C           RACESS(J) - FILE NAMES OF THE MOS-2000 EXTERNAL RANDOM ACCESS
C                       FILES CORRESPONDING TO KFILRA(J) (J=1,5).
C                       (CHARACTER*60)
C               NUMRA - THE NUMBER OF VALUES IN KFILRA( ) AND RACESS( ).
C               KFILX - THE UNIT NUMBER FOR THE OUTPUT RANDOM ACCESS
C                       FILE.  (OUTPUT)
C               CFILX - THE FILE NAME OF THE OUTPUT RANDOM ACCESS
C                       FILE CORRESPONDING TO KFILX.  (CHARACTER*60)
C                       (OUTPUT)
C              OUTNAM - NAME OF DATA SET FOR PACKED VECTOR OUTPUT TO
C                       BE WRITTEN TO UNIT KFILIO.  (CHARACTER*60)
C              AOTNAM = NAME OF DATA SET FOR ASCII OUTPUT TO
C                       BE WRITTEN TO UNIT KFILAO.  (CHARACTER*60)
C                NSTA - THE NUMBER OF STATIONS BEING DEALT WITH.  THE
C                       NUMBER OF VALUES IN CCALL( , ), ETC.  MAXIMUM
C                       OF ND1.
C                 KGP - THE NUMBER OF GROUPS OF STATIONS TO BE PROCESSED.
C                       MAXIMUM OF ND1.
C               NVRBL - THE NUMBER OF VARIABLES.
C              MODRUN - USED TO SET THE OUTPUT DD. READ FROM CONTROL FILE.
C            ISTOP(J) - FOR J=1, ISTOP IS INCREMENTED BY 1 EACH TIME
C                       AN ERROR OCCURS THAT MAY BE FATAL.
C                       FOR J=2, ISTOP IS INCREMENTED BY 1 WHENEVER AN
C                       INPUT DATA RECORD IS NOT FOUND.
C               MINPK - MINIMUM GROUP SIZE WHEN PACKING THE INTERPOLATED
C                       VALUES.  SET IN DATA STATEMENT TO 14, THE AGREED
C                       ON VALUE FOR MOS-2000.
C               LASTL - THE LAST LOCATION IN CORE( ) USED.  THIS MAY BE
C                       MODIFIED, ALONG WITH ITEMS, IF COMPACTION IS
C                       DONE BY GCPAC.  INITIALIZED TO ZERO ON FIRST
C                       ENTRY TO GSTORE.  ALSO SET TO ZERO IN U915 IN
C                       CASE GSTORE IS NOT ENTERED.
C               LASTD - TOTAL NUMBER OF PHYSICAL RECORDS ON DISK.  INITIALIZED
C                       TO ZERO ON FIRST ENTRY TO GSTORE.  ALSO SET TO
C                       ZERO IN U915 IN CASE GSTORE IS NOT ENTERED.
C              NSTORE - THE NUMBER OF TIMES GSTORE HAS BEEN ENTERED.
C              NFETCH - THE NUMBER OF TIMES GFETCH HAS BEEN ENTERED.
C              NTOTBY - THE TOTAL NUMBER OF BYTES ON THE FILE ASSOCIATED
C                       WITH UNIT NO. KFILIO (THE OUTPUT FILE).
C                       IT IS INITIALIZED BY SKIPWR AND UPDATED AS
C                       DATA ARE WRITTEN.  (THIS DOES NOT ACCOUNT FOR
C                       ANY BYTES WRITTEN BY THE SYSTEM THAT ARE NOT
C                       PART OF THE FORTRAN WRITES.  THIS IS PROBABLY
C                       8 BYTES PER RECORD.)
C              NTOTRC - THE TOTAL NUMBER OF RECORDS IN THE FILE.  IT IS
C                       INITIALIZED BY SKIPWR AND UPDATED AS DATA ARE
C                       WRITTEN.
C              NCOMBO - REQUIRED BY GFETCH.  NOT ACTUALLY USED.
C              NRRDAT - REQUIRED BY GFETCH.  THE VALUE SET BY DATA
C                       STATEMENT WILL CAUSE THE DATA STORED TO BE KEPT
C                       FROM DAY TO DAY.
C               ISTAB - RETURNED FROM OPTX, BUT NOT USED.
C               NPCDF - THE NUMBER OF VALUES IN PDF( ), CDF( ), AND
C                       XAXIS( ).
C              NCDFTH - NUMBER OF VALUES IN CDFTH( ) AND XCDF( ).
C                 MEM - THE NUMBER OF MEMBERS AVERAGED FOR THE
C                       VARIABLE PROCESSED.  (INTERNAL)
C                  NN = THE LOCATION IN THE ID( , ) LIST OF THE VARIABLE
C                       TO PROCESS.  IT IS SET TO 1 INITIALLY AND
C                       MODIFIED IN DISTF VIA OPTY.  (INTERNAL)
C
C        SUBPROGRAMS CALLED:
C             UNIQUE:   - INT915
C          LIBRARY:
C             ENSLIB90  - GSTORE, PACKV, PRU660, SETMIS, TRAIL, RDTDLM, WRTDLM,
C                         UPDAT, OPTX, WRTDLR, CLFILM
C
C        EXIT STATES:
C          COND =    0  - SUCCESSFUL RUN
C                  120  - ONE OR MORE STATIONS NOT FOUND IN THE DIRECTORY.
C                         THIS IS NOT FATAL. (FROM OPTX).
C                  135  - MISMATCH OF CALL LETTERS TO BE WRITTEN AND THOSE
C                         ON RANDOM ACCESS FILE.
C                  141  - ERROR WRITING STATION DIRECTORY ON RANDOM ACCESS FILE.
C                  155  - THE DIRECTORY DID NOT EXIST. THIS IS NOT AN ERROR.
C                         (FROM RDTDLM).
C                  238  - TOTAL NUMBER OF ERRORS ALLOWED HAS BEEN EXCEEDED.
C                 1090  - ERROR READING STATION DIRECTORY.
C
C        ATTRIBUTES:
C        LANGUAGE: FORTRAN 90 (xlf90 compiler)
C        MACHINE:  IBM SP
C
C $$$
C
      PARAMETER(NDIM=3)
C
      CHARACTER*4 IPINIT
      CHARACTER*8 CCALL(ND1,6)
      CHARACTER*8 CCALLD(ND5)
      CHARACTER*20 NAME(ND1)
      CHARACTER*32 PLAIN(ND4)
      CHARACTER*32 PLAINT
      CHARACTER*60 OUTNAM,AOTNAM,RACESS(5),CFILX
C
      DIMENSION ISDATA(ND1),SDATA(ND1),NGP(ND1),MWORK(ND1)
      DIMENSION ICALL(L3264W,ND1,6)
      DIMENSION XDATA(ND1,ND2),SDDATA(ND1,ND2)
      DIMENSION ID(4,ND4),IDPARS(15,ND4),TRESHL(ND4),TRESHU(ND4),
     1          JD(4,ND4),JP(3,ND4),ITAU(ND4),KER(ND4),NCAT(ND4),
     2          ISD(ND4),SD(ND4),DS(ND4),ISCALD(ND4)
      DIMENSION IPLAIN(L3264W,4,ND4),IPLAINT(L3264W,4,1)
      DIMENSION IPACK(ND5),ICALLD(L3264W,ND5),
     1          IWORK(ND5),DATA(ND5)
      DIMENSION IS0(ND7),IS1(ND7),IS2(ND7),IS4(ND7)
      DIMENSION IDATE(ND8),NWORK(ND8)
      DIMENSION LSTORE(12,ND9)
      DIMENSION CORE(ND10)
      DIMENSION CDFTH(ND12),XCDF(ND1,ND12)
      DIMENSION XAXIS(ND11),PDF(ND11),CDF(ND11)
      DIMENSION KFILRA(5)
      DIMENSION IP(25),ISTOP(3),LD(4),LDPARS(15)
      DIMENSION ITABLE(2,NDIM) 
C
C
C        SET ITABLE. THIS IS ONLY USED BY PQPF IDS TO 'RESET'
C        THE ID TO THE UNCONDITIONAL ID FOR OUTPUT. IT MAY BE
C        BETTER TO MAKE THESE CHANGES PART OF THE CONTROL FILE.
C        THAT IS, ADD A FORECAST CORRESPONDENCE TABLE LIKE U705.
C
C        CHANGE ID
C                   FROM:   TO:
      DATA ITABLE /2032201,2032101,
     1             2033301,2033101,
     2             2034301,2034101/

C
      DATA ISTOP/0,0,0/
      DATA KFIL10/99/
      DATA KFILAO/0/
      DATA IP/25*0/
      DATA LASTL/0/,
     1     LASTD/0/
      DATA NFETCH/0/,
     1     NSTORE/0/
      DATA MINPK/14/
      DATA NTOTBY/0/,
     1     NTOTRC/0/
      DATA NCOMBO/999/
      DATA NRRDAT/2100010100/
      DATA LSTOP/0/
      DATA MITEMS/0/,
     1     LITEMS/0/
C
C        READ CONTROL INFORMATION.
C
      CALL INT915(KFILDI,KFILDO,KFILIO,KFILAO,KFILCP,KFILAI,IP,
     1            CCALL,MWORK,IWORK,SDATA,XDATA,
     2            ISDATA,IPACK,NGP,KGP,NAME,NSTA,ND1,CCALLD,ND5,
     3            ID,IDPARS,TRESHL,TRESHU,JD,JP,NCAT,ITAU,KER,
     4            ISD,SD,DS,ISCALD,
     5            PLAIN,L3264B,L3264W,ND4,ND2,MODRUN,
     7            KFILRA,RACESS,NUMRA,KFILX,CFILX,
     7            OUTNAM,AOTNAM,IDATE,NDATES,NWORK,ND8,
     8            JSTOP,NREPLA,NCHECK,
     9            NPRINT,NVRBL,
     B            CDFTH,NCDFTH,ND12,
     A            NTOTBY,NTOTRC,IPINIT,ISTOP(1),IER)
C        NOTE THAT MWORK( ), IWORK( ), SDATA( ), AND XDATA( ),
C        ARE THE SAME AS NELEV( ), IWBAN( ), STALAT( ), AND
C        STALON( ), RESPECTIVELY, IN INT710.
C        NOTE THAT FOR IWORK, ND5 MUST BE MAINTAINED AS GE ND1.
C
C        WHEN FORECASTS ARE TO BE WRITTEN TO THE RANDOM ACCESS
C        FILE, READ CALL LETTERS IF THEY EXIST AND CHECK THEM
C        TO MAKE ADDITION OF RECORDS POSSIBLE.
C
      IF(KFILX.EQ.0)GO TO 145
C
      LD(1)=400001000
      LD(2)=0
      LD(3)=0
      LD(4)=0
C      CALL RDTDLM(KFILDO,KFILX,CFILX,LD,ICALLD,ND1*L3264W,NVALUE,
CINTEL
C      CALL RDTDLM(KFILDO,KFILX,CFILX,LD,ICALLD,ND1*L3264W,NVALUE,
C     1            L3264B,IER)
      CALL RDTDLMC(KFILDO,KFILX,CFILX,LD,ICALLD,ND1*L3264W,NVALUE,
     1            L3264B,IER)
C
      IF(IER.EQ.155)THEN
C           THE DIRECTORY DID NOT EXIST.  THIS IS NOT AN ERROR.
         WRITE(KFILDO,1115)CFILX
 1115    FORMAT('     THE DIRECTORY DOES NOT EXIST ON FILE ',A60,/,
     1          '     SO WRITE THE CALL LETTERS.')
         GO TO 140
C
      ELSEIF(IER.NE.0)THEN
         WRITE(KFILDO,112)IER
 112     FORMAT('     ERROR READING STATION DIRECTORY',
     1          ' IN RANDOM ACCESS FILE IN U915 AT 112.  IER =',I4)
         CALL W3TAGE('U915')
         STOP 1090
      ENDIF
C
      NVALUE=NVALUE/L3264W
C        THE CALL LETTERS ARE 8 BYTES EACH.  THIS IS TWO WORDS
C        ON A 32-BIT MACHINE.  THE NUMBER OF WORDS WRITTEN AND
C        READ MUST ACCOUNT FOR THIS.  THE ACTUAL NUMBER OF CALL
C        LETTERS IS NVALUE/L3264W.
C
C        CALL LETTERS WERE READ.  DO THEY MATCH?
C
      IF(NVALUE.EQ.NSTA)GO TO 125
      WRITE(KFILDO,120)NVALUE,NSTA,
     1     (CCALL(J,1),CCALLD(J),J=1,MAX(NVALUE,NSTA))
 120  FORMAT(/,' ****NUMBER OF CALL LETTERS READ FROM',
     1         ' RANDOM ACCESS OUTPUT FILE =',I5,/,
     1         '     DOES NOT EQUAL THE NUMBER TO BE WRITTEN =',I5,
     2         '.  STOP IN U915 AT 120.',/,('     ',A8,1X,A8))
C        VALUES BEYOND NVALUE IN CCALL( , ) WILL NOT BE
C        CHARACTER ORIENTED, AND PROBABLY NOT PRINTABLE AS A8.
      CALL W3TAGE('U915')
      STOP 120
C
 125  MATCH=0
C
      DO 130 J=1,NSTA
      IF(CCALL(J,1).EQ.CCALLD(J))GO TO 130
      WRITE(KFILDO,126)CCALL(J,1),CCALLD(J)
 126  FORMAT(/,' ****MISMATCH OF CALL LETTERS TO BE WRITTEN',
     1         ' AND THOSE ON RANDOM ACCESS FILE.',2(2X,A8))
      MATCH=1
 130  CONTINUE
C
      IF(MATCH.EQ.0)GO TO 145
      WRITE(KFILDO,134)(CCALL(J,1),CCALLD(J),J=1,NSTA)
 134  FORMAT(/,' TO WRITE  ON CONSTANT FILE',/,
     1      (' ',A8,2X,A8))
      WRITE(KFILDO,135)
 135  FORMAT(/,'     STOP IN U915 AT 135.' ) 
      CALL W3TAGE('U915')
      STOP 135
C  
C        WRITE CALL LETTERS RECORD WHEN SUCH A RECORD DOES
C        NOT EXIST.
C
C 140  CALL WRTDLM(KFILDO,KFILX,CFILX,LD,ICALL,NSTA*L3264W,
CINTEL
C 140  CALL WRTDLM(KFILDO,KFILX,CFILX,LD,ICALL,NSTA*L3264W,
C     1               0,0,L3264B,IER)
 140  CALL WRTDLMC(KFILDO,KFILX,CFILX,LD,ICALL,NSTA*L3264W,
     1               0,0,L3264B,IER)
C        THE CALL LETTERS ARE 8 BYTES EACH.  THIS IS TWO WORDS
C        ON A 32-BIT MACHINE.  THE NUMBER OF WORDS WRITTEN AND
C        READ MUST ACCOUNT FOR THIS.
C
      IF(IER.NE.0)THEN
         WRITE(KFILDO,141)IER
 141     FORMAT(/,' ****ERROR WRITING STATION DIRECTORY',
     1            ' ON RANDOM ACCESS FILE IN U915 AT 141.  IER =',I4)
         CALL W3TAGE('U915')
         STOP 141
      ENDIF
C
C        FILL THE INDEX ISDATA( ) FOR STORING BY GSTORE.
C
 145  DO 150 K=1,NSTA
      ISDATA(K)=K
 150  CONTINUE
C
      CALL GSTORE(KFILDO,KFIL10,LD,NCOMBO,LSTORE,ND9,LITEMS,
     1            ISDATA,NSTA,1,NRRDAT,0,
     2            CORE,ND10,LASTL,NBLOCK,LASTD,NSTORE,L3264B,IER)
C        NOTE THAT ISDATA( ) IS INTEGER.  ALTHOUGH THE CORRESPONDING
C        VARIABLE IN GSTORE IS REAL, THIS IS OK.
C
      DO 300 ND=1,NDATES
C
C        SET UP SOME VALUES FOR LOADING IS1( ) WHEN PACKING.
C
      NDATE=IDATE(ND)
      NYR=NDATE/1000000
      NMO=NDATE/10000-NYR*100
      NDA=NDATE/100-NYR*10000-NMO*100
      NHR=NDATE-NYR*1000000-NMO*10000-NDA*100
C
C        FIND/COMPUTE ALL VARIABLES FOR THE DATE IN NDATE.
C
      NN=1
C        NN IS THE PLACE IN THE ID LIST OF THE FIRST VARIABLE
C        NOT YET USED.  THE ID'S NEED NOT BE IN ORDER.
      NS=99999999
C
      DO 250 N=1,NVRBL
C
      IER=0
C 
      IF(NN.EQ.NS)THEN
         WRITE(KFILDO,101)NS
 101     FORMAT(/,' ****ERROR IN U915, NS =',I4,
     1            '.  TO PROCEED WOULD BE',
     2            ' AN INFINITE LOOP.  ABORT VARIABLE.',/,
     3            '     LIKELY FATAL.  PROCEEDING.')
         ISTOP(1)=ISTOP(1)+1
         GO TO 250
      ENDIF
C
      NS=NN
C        NN IS MODIFIED IN DISTF.  SAVE IT HERE FOR LATER USE.
C
C        ALL VARIABLES ARE HANDED THROUGH OPTY.
C
      IF(ITAU(N).EQ.0)THEN
         MDATE=NDATE
      ELSE
         CALL UPDAT(NDATE,ITAU(N),MDATE)
      ENDIF
C
      CALL OPTY(KFILDO,KFIL10,KFILAO,KFILAI,IP(12),IP(15),
     1          KFILRA,RACESS,NUMRA,
     2          ID,IDPARS,JD,TRESHL,TRESHU,ITAU,NVRBL,
     3          NDATE,CCALL,ISDATA,SDATA,ND1,NSTA,
     4          XDATA,SDDATA,ND2,KER,ISD,SD,DS,NN,MEM,
     5          ICALLD,CCALLD,IPACK,IWORK,DATA,ND5,
     6          LSTORE,ND9,LITEMS,CORE,ND10,
     7          NBLOCK,NFETCH,MODRUN,
     8          IS0,IS1,IS2,IS4,ND7,
     9          XAXIS,PDF,CDF,ND11,NPCDF,CDFTH,XCDF,NCDFTH,
     A          L3264B,L3264W,ISTAB,ISTOP,IER)
      IF(MEM.EQ.0)THEN
         WRITE(KFILDO,1343)(ID(J,NS),J=1,4),NDATE
 1343    FORMAT(/' ****NO FORECASTS FOUND FOR VARIABLE ',
     1             2X,I9.9,1X,I9.9,1X,I9.9,1X,I10.3,
     2           ' DATE',I12,/,
     3           '     ABORT THIS DATE')
         GO TO 300
      ENDIF
C
      IF(IER.NE.0)THEN
C
         IF(IER.EQ.120)THEN
            ISTOP(3)=ISTOP(3)+1
C              IER = 120 FROM FINDST IN CONST IN OPTX MEANS ONE OR MORE
C              STATIONS NOT FOUND IN THE DIRECTORY.  THIS IS NOT FATAL.
            IER=0
         ELSEIF(IER.EQ.777)THEN
            ISTOP(3)=ISTOP(3)+1
C              IER = 777 MEANS SD = 0 IN DISTF.  IT IS HANDLED, SO
C              PROCEED, BUT RECORD IN ISTOP( ).
            IER=0
         ELSE
            ISTOP(3)=ISTOP(3)+1
C              AN ERROR IN OPTX WILL GENERATE A DIAGNOSTIC AND DATA IN
C              XDATA( , ) HAVE BEEN SET TO 9999.  ISTOP(2) IS INCREMENTED,
C              EVEN WHEN IER = 47, WHICH JUST MEANS DATA COULD NOT 
C              BE FOUND.  (IT IS POSSIBLE THAT ERRORS OTHER THAN JUST
C              MISSING DATA OCCURRED.)
         ENDIF
C
      ENDIF
C
C        AT THIS POINT, THE FOLLOWING DATA ARE AVAILABLE:
C           XCDF(K,J)   = THE VALUE OF THE VARIABLE FOR STATION K FOR
C                         WHICH THE PROBABILITY IN THE CDF CORRESPONDING
C                         TO THE VALUES IN CDFTH(J) IS BELOW, J=1,NCDFTH.
c           XDATA(K,J)F = THE SINGLE VALUES FROM EACH ENSEMBLE FOR
C                         STATION K AND ENSEMBLE MEMBER J (J=1,M).
C           SDDATA(K,J) = THE SD VALUES FOR EACH ENSEMBLE MEMBER FOR
C                         STATION K AND ENSEMBLE MEMBER J (J=1,M).
C        THE FULL SCALE CDF( ) AND XAXIS( ) VALUES HAVE BEEN WRITTEN
C        IF DESIRED IN DISTF.  WHEN MORE THAN ONE MEMBER IS AVERAGED,
C        THE DD BECOMES 76, THE LLLL THE PROBABILITY LEVEL, AND THE
C        JP( , ) IS THAT OF THE FIRST ELEMENT IN THE LIST USED.
C
C        PACK AND WRITE THE CDF'S REPRESENTED BY THE BREAKPOINTS IN
C        CDFTH( ).
C
      DO 245 L=1,NCDFTH 
      LD(1)=ID(1,NS)
C        CHECK ITABLE TO SEE IF WE NEED TO CHANGE THE ID.
C        KEEP THE DD FROM ID INTACT.
      DO 200 II=1,NDIM
        IIDD=LD(1)-(LD(1)/100)*100
        IF(LD(1)/100.EQ.ITABLE(1,II)) THEN
          LD(1)=ITABLE(2,II)*100+IIDD
        ENDIF
 200  CONTINUE
C    
      IF(MEM.GT.1)THEN
         LD(1)=(LD(1)/100)*100+MODRUN
C           WHEN MORE THAN ONE ENSEMBLE IS INVOLVED, USE DD = MODRUN
C           OTHERWISE, USE THE DD OF THE MEMBER.
      ENDIF
C
      LD(2)=(ID(2,NS)/100000000)*100000000+NINT(CDFTH(L)*100)*10000
C        THIS PUTS THE PROBABILITY THRESHOLD INTO LLLL OF WORD 2.
C        IT ASSUMES UUUU = 0, BUT RETAINS THE FIRST DIGIT, V.
      LD(3)=ID(3,NS)
C        THE 'G' IS STRIPPED OFF 
      LD(4)=ID(4,NS)-IDPARS(15,NS)
C
D      WRITE(KFILDO,365)LD,(JP(J,1),J=1,3),NS,IP(15)
D365   FORMAT(/' AT 365 IN U915--LD,(JP(J),J=1,3),NS,IP15',4I11,5I3)
C
      IF(JP(1,NS).EQ.0)GO TO 245
C        SET XMISSS = 0. OR 9997. DEPENDING ON WHETHER A 9997.
C        APPEARS IN THE DATA TO BE PACKED.  SET XMISSP = 0.
C        OR 9999. DEPENDING ON WHETHER A 9999. OR 9997. APPEAR
C        IN THE DATA TO BE PACKED.
      CALL SETMIS(KFILDO,XCDF(1,L),NSTA,XMISSP,XMISSS)
C
      CALL PRSID1(KFILDO,LD,LDPARS)
      PLAINT=PLAIN(NS)
      PLAINT(24:26)='CDF'
C
C        PACK AND WRITE THE DATA.  THE DATA ARE ALWAYS PACKED
C        AND WRITTEN TO THE MOS-2000 RANDOM ACCESS FILE.
C        THEY ARE WRITTEN TO THE SEQUENTIAL FILE ONLY IF JP(1,N) GT 0.
C
      CALL PACKV(KFILDO,KFILIO,LD,LDPARS,
     1           JP(1,NS),ISCALD(NS),0,
     2           IPLAINT,PLAINT,NDATE,NYR,NMO,NDA,NHR,
     3           CCALL,ISDATA,XCDF(1,L),ND1,NSTA,IPACK,ND5,MINPK,
     4           IS0,IS1,IS2,IS4,ND7,XMISSP,XMISSS,
     5           IP(15),LWORDS,NTOTBY,NTOTRC,
     6           L3264B,L3264W,ISTOP(1),IER)
      IF(KFILX.NE.0)THEN
         CALL WRTDLR(KFILDO,KFILX,CFILX,IS1(9),ICALL,CCALL,ND1,NSTA,
     1               ICALLD,CCALLD,ND5,IPACK,LWORDS,
     2               NREPLA,NCHECK,L3264B,L3264W,IER) 
         IF(IER.NE.0)ISTOP(1)=ISTOP(1)+1
C        AN ERROR IN WRTDLR WILL PRINT A DIAGNOSTIC.
      ENDIF
C
      IF(ISTOP(1).GT.JSTOP)THEN
         WRITE(KFILDO,801)ISTOP(1),N,IDATE(ND)
         WRITE(KFILDO,806)NSTORE
         WRITE(KFILDO,807)NFETCH
         CALL W3TAGE('U915')
         STOP 800 
      ENDIF
C
 245  CONTINUE
C     
C        COMPUTE AND WRITE THE MEANS OF THE VALUES AND SD'S OF THE
C        MEM ENSEMBLE MEMBERS IN XDATA( ,1) AND SDDATA( ,1),
C        RESPECTIVELY, WHEN DESIRED.
C
      IF(JP(3,NS).EQ.0)GO TO 399
C        WRITING THE DATA IS NOT DESIRED.
C
      IF(MEM.GT.1)THEN
C           MEM MUST BE GE 0 AT THIS POINT.  THERE IS NO NEED TO
C           COMPUTE THE MEANS IF THERE IS ONLY ONE MEMBER.  NOTE
C           THAT THE SINGLE VALUE AND THE MEAN OCCUPY XDATA( , 1) AND
C           SDDATA( , 1) AND CAN BE PACKED FROM THE SAME VARIABLE
C           LOCATIONS WHETHER OR NOT THE MEAN WAS ACTUALLY COMPUTED.
C
         DO 248 K=1,NSTA
         ICOUNT=0
         XSUM=0.
         SDSUM=0.
C
         DO 247 L=1,MEM
C
         IF(NINT(XDATA(K,L)).EQ.9999)GO TO 247
         XSUM=XSUM+XDATA(K,L)
C         SDSUM=SDSUM+SDDATA(K,L)
C           ASSUMES A NON-MISSING SD FOR EVERY NON-MISSING VALUE.
         ICOUNT=ICOUNT+1
 247     CONTINUE
C
C           COMPUTE THE MEANS OF THE SINGLE VALUE FORECASTS AND THE
C           STANDARD DEVIATIONS.
C
         IF(ICOUNT.EQ.0)GO TO 248
C           WHEN ICOUNT = 0, ALL MEMBERS ARE MISSING AND XDATA(K,1)
C           AND SDDATA(K,1) ARE MISSING.
         XDATA(K,1)=XSUM/ICOUNT
C         SDDATA(K,1)=SDSUM/ICOUNT
 248     CONTINUE
C
      ENDIF 
C
C        WRITE THE MEANS OF THE VALUES.  IF THERE IS ONLY ONE MEMBER,
C        THE VALUES WILL BE THE SAME AS FOR THAT MEMBER.  HOWEVER,
C        THE WRITING WILL BE TO A DIFFERENT FILE WITH A AND ID
C        OF 76 ID FOR SEVERAL MEMBERS.
C
      LD(1)=ID(1,NS)
C        CHECK ITABLE TO SEE IF WE NEED TO CHANGE THE ID.
C        KEEP THE DD FROM ID INTACT.
      DO 260 II=1,NDIM
        IIDD=LD(1)-(LD(1)/100)*100
        IF(LD(1)/100.EQ.ITABLE(1,II)) THEN
          LD(1)=ITABLE(2,II)*100+IIDD
        ENDIF
 260  CONTINUE
C
      IF(MEM.GT.1)THEN
         LD(1)=(LD(1)/100)*100+MODRUN
C           WHEN MORE THAN ONE ENSEMBLE IS INVOLVED, USE DD = MODRUN
C           OTHERWISE, USE THE DD OF THE MEMBER.
      ENDIF
C
      LD(2)=003000000
C        THIS SETS LLLL IN WORD 2 = 0300 TO INDICATE MEANS.
C        THE DD WILL ALSO INDICATE IT APPLIES TO ONE OR MORE
C        MEMBERS.
      LD(3)=ID(3,NS)
      LD(4)=ID(4,NS)-IDPARS(15,NS)
C
C        SET XMISSS = 0. OR 9997. DEPENDING ON WHETHER A 9997.
C        APPEARS IN THE DATA TO BE PACKED.  SET XMISSP = 0.
C        OR 9999. DEPENDING ON WHETHER A 9999. OR 9997. APPEAR
C        IN THE DATA TO BE PACKED.
C
      CALL SETMIS(KFILDO,XDATA,NSTA,XMISSP,XMISSS)
C
C        PACK AND WRITE THE DATA.
C
      CALL PRSID1(KFILDO,LD,LDPARS)
      PLAINT=PLAIN(NS)
      PLAINT(24:27)='MEAN'
      CALL PACKV(KFILDO,KFILIO,LD,LDPARS,
     1           JP(1,NS),ISCALD(NS),0,
     2           IPLAINT,PLAINT,NDATE,NYR,NMO,NDA,NHR,
     3           CCALL,ISDATA,XDATA,ND1,NSTA,IPACK,ND5,MINPK,
     4           IS0,IS1,IS2,IS4,ND7,XMISSP,XMISSS,
     5           IP(15),LWORDS,NTOTBY,NTOTRC,
     6           L3264B,L3264W,ISTOP(1),IER)
      IF(KFILX.NE.0)THEN
         CALL WRTDLR(KFILDO,KFILX,CFILX,IS1(9),ICALL,CCALL,ND1,NSTA,
     1               ICALLD,CCALLD,ND5,IPACK,LWORDS,
     2               NREPLA,NCHECK,L3264B,L3264W,IER) 
         IF(IER.NE.0)ISTOP(1)=ISTOP(1)+1
C        AN ERROR IN WRTDLR WILL PRINT A DIAGNOSTIC.
      ENDIF
C
      IF(ISTOP(1).GT.JSTOP)GO TO 800
C
C        WRITE THE SD'S OF THE DATA
C
      LD(1)=ID(1,NS)
C        CHECK ITABLE TO SEE IF WE NEED TO CHANGE THE ID.
C        KEEP THE DD FROM ID INTACT.
      DO 290 II=1,NDIM
        IIDD=LD(1)-(LD(1)/100)*100
        IF(LD(1)/100.EQ.ITABLE(1,II)) THEN
          LD(1)=ITABLE(2,II)*100+IIDD
        ENDIF
 290  CONTINUE
C
      IF(MEM.GT.1)THEN
         LD(1)=(LD(1)/100)*100+MODRUN
C           WHEN MORE THAN ONE ENSEMBLE IS INVOLVED, USE DD = MODRUN
C           OTHERWISE, USE THE DD OF THE MEMBER.
      ENDIF
C
      LD(2)=002000000
C        THIS SETS LLLL IN WORD 2 = 0200 TO INDICATE STANDARD
C        DEVIATIONS.   THE DD WILL INDICATE WHETHER IT IS A
C        SINGLE OR MEAN.  IF IT IS A SINGLE, THE DATA WILL BE
C        THE SAME AS ON THE INCOMING FILE.
      LD(3)=ID(3,NS)
      LD(4)=ID(4,NS)-IDPARS(15,NS)
C
C        SET XMISSS = 0. OR 9997. DEPENDING ON WHETHER A 9997.
C        APPEARS IN THE DATA TO BE PACKED.  SET XMISSP = 0.
C        OR 9999. DEPENDING ON WHETHER A 9999. OR 9997. APPEAR
C        IN THE DATA TO BE PACKED.
C
      CALL SETMIS(KFILDO,SDDATA(1,1),NSTA,XMISSP,XMISSS)
C
C        PACK AND WRITE THE DATA.
C
      CALL PRSID1(KFILDO,LD,LDPARS)
 
      PLAINT=PLAIN(NS)
      PLAINT(24:25)='SD'
      ISCALDT=ISCALD(NS)+1
C        INCREASE THE PACKED PRECISION FOR THE AVERAGE SD'S.
      CALL PACKV(KFILDO,KFILIO,LD,LDPARS,
     1           JP(1,NS),ISCALDT,0,
     2           IPLAINT,PLAINT,NDATE,NYR,NMO,NDA,NHR,
     3           CCALL,ISDATA,SDDATA,ND1,NSTA,IPACK,ND5,MINPK,
     4           IS0,IS1,IS2,IS4,ND7,XMISSP,XMISSS,
     5           IP(15),LWORDS,NTOTBY,NTOTRC,
     6           L3264B,L3264W,ISTOP(1),IER)
      IF(KFILX.NE.0)THEN
         CALL WRTDLR(KFILDO,KFILX,CFILX,IS1(9),ICALL,CCALL,ND1,NSTA,
     1               ICALLD,CCALLD,ND5,IPACK,LWORDS,
     2               NREPLA,NCHECK,L3264B,L3264W,IER) 
         IF(IER.NE.0)ISTOP(1)=ISTOP(1)+1
C        AN ERROR IN WRTDLR WILL PRINT A DIAGNOSTIC.
      ENDIF
C
 2491 IF(ISTOP(1).GT.JSTOP)GO TO 800
C 
 399  IF(NN.EQ.9999)GO TO 300
C
 250  CONTINUE
C
 300  CONTINUE
C
C        WRITE TRAILER RECORD AND EOF UNLESS KFILIO = 0.  IF THERE 
C        IS AN ERROR, TRAIL WILL PRODUCE A DIAGNOSTIC.
C
      IF(KFILIO.NE.0)THEN
         CALL TRAIL(KFILDO,KFILIO,L3264B,L3264W,NTOTBY,NTOTRC,IER)
         ENDFILE KFILIO
      ENDIF
C
C        CLOSE RANDOM ACCESS FILE.
C
      CALL CLFILM(KFILDO,KFILX,IER)
C 
C        TOTAL ERRORS ALLOWED HAVE BEEN EXCEEDED.
C
 800  IF(ISTOP(1).GT.JSTOP)THEN 
         WRITE(KFILDO,801)ISTOP(1),N,IDATE(ND)
 801     FORMAT(/,' NUMBER OF ERRORS =',I6,' AFTER VARIABLE NO.',I4,
     1            ' DATE',I11,' EXCEEDS JSTOP.',
     2            '  STOP IN U915 AT 238.')   
         WRITE(KFILDO,806)NSTORE
         WRITE(KFILDO,807)NFETCH
         CALL W3TAGE('U915')
         STOP 800 
      ENDIF
C 
C        CLOSE UP SHOP.
C
      WRITE(KFILDO,806)NSTORE
 806  FORMAT(/,' THE MOS-2000 INTERNAL FILE HAS BEEN ACCESSED BY',
     1         ' GSTORE',I11,' TIMES.')
      WRITE(KFILDO,807)NFETCH
 807  FORMAT(' THE MOS-2000 INTERNAL FILE HAS BEEN ACCESSED BY',
     1       ' GFETCH',I11,' TIMES.')
      IF(KFILIO.EQ.0)GO TO 8079
      WRITE(KFILDO,8075)NTOTBY,NTOTRC,OUTNAM
 8075 FORMAT(/,' A TOTAL OF ',I11,' BYTES IN ',I7,' RECORDS NOW',
     1         ' EXIST ON FILE ',A60)
 8079 IF(ISTOP(1).NE.0)WRITE(KFILDO,808)ISTOP(1)
 808  FORMAT(/,' AT LEAST ISTOP(1) =',I6,
     1         ' ERRORS HAVE OCCURRED ON THIS RUN.')
      IF(ISTOP(2).NE.0.AND.ISTOP(1).EQ.0)WRITE(KFILDO,809)ISTOP(2)
 809  FORMAT(/,' AT LEAST ISTOP(2) =',I6,
     1         ' DATA RECORDS NOT FOUND ON THIS RUN.')
      IF(ISTOP(3).NE.0.AND.ISTOP(1).NE.0)WRITE(KFILDO,8090)ISTOP(2)
 8090 FORMAT(' AT LEAST ISTOP(2) =',I6,
     1       ' DATA RECORDS NOT FOUND ON THIS RUN.')
      IF(ISTOP(1).EQ.0.AND.ISTOP(2).EQ.0)WRITE(KFILDO,810)
 810  FORMAT(/,' NO ERRORS HAVE BEEN DETECTED ON THIS RUN.')
      WRITE(KFILDO,811)
 811  FORMAT(' ')
      RETURN
      END
